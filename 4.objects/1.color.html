<html>
<head>

<title>Color Detection</title>

<style>
body {
  align-items: center;
  display: flex;
  flex-direction: row;
  justify-content: center;
  margin: 0;
  padding: 0;
}

video {
  position: absolute;
  visibility: hidden;
}
</style>

</head>
<body>

<!-- Document elements -->
<video width="640" height="480"></video>
<canvas width="640" height="480"></canvas>

<script>
class Follower {
  constructor() {
    this.color = null;

    document.body.addEventListener( 'keypress', ( evt ) => this.doKeyPress( evt ) );

    // Element references
    this.canvas = document.querySelector( 'canvas' );
    this.context = this.canvas.getContext( '2d' );
    this.video = document.querySelector( 'video' );

    // Attach web camera to video element
    navigator.mediaDevices.getUserMedia( {audio: false, video: true} )
    .then( ( stream ) => {
      this.video.srcObject = stream;
      this.video.play();

      // Look for color
      this.detect();
    } )
    .catch( ( error ) => {
      console.log( error );
    } );        
  }

  detect() {
    // Put video onto canvas
    this.context.drawImage( this.video, 0, 0, this.canvas.clientWidth, this.canvas.clientHeight );

    // Default highlight placement
    // Used when no color is set
    let view = {
      x: Math.round( ( this.canvas.clientWidth - Follower.VIEW_SIZE ) / 2 ),
      y: Math.round( ( this.canvas.clientHeight - Follower.VIEW_SIZE ) / 2 ),
      width: Follower.VIEW_SIZE,
      height: Follower.VIEW_SIZE      
    };

    // If color has been set
    if( this.color !== null ) {
      // Get the pixels from the canvas
      let pixels = this.context.getImageData( 0, 0, this.canvas.clientWidth, this.canvas.clientHeight );

      // Get color channels if needed
      if( !this.color.hasOwnProperty( 'red' ) ) {
        this.color.red = pixels.data[this.color.index];
        this.color.green = pixels.data[this.color.index + 1];        
        this.color.blue = pixels.data[this.color.index + 2];                
        console.log( this.color );
      }

      let closest = null;
      let changed = false;

      // Iterate through pixels
      for( let y = 0; y < this.canvas.clientHeight; y++ ) {
        for( let x = 0; x < this.canvas.clientWidth; x++ ) {
          // Calculate pixel location
          let index = ( ( y * this.canvas.clientWidth ) + x ) * 4;

          // Get color channels
          let sample = {  
            red: pixels.data[index],
            green: pixels.data[index + 1],
            blue: pixels.data[index + 2]
          };

          // Calculate distance
          // Euclidean does not reflect perception
          let distance = Math.sqrt(
            Math.pow( ( this.color.red - sample.red ), 2 ) + 
            Math.pow( ( this.color.green - sample.green ), 2 ) + 
            Math.pow( ( this.color.blue - sample.blue ), 2 )                        
          );          

          if( closest === null ) {
            closest = distance;
            changed = true;
          } else {
            if( distance < closest ) {
              closest = distance;
              changed = true;
            }
          }          

          if( changed ) {
            view.x = x - Math.round( view.width / 2 );
            view.y = y - Math.round( view.height / 2 );
            changed = false;
          }
        }
      }      
    }

    // Draw highlight
    this.context.strokeStyle = 'red';          
    this.context.strokeRect( view.x, view.y, view.width, view.height );      

    // Keep going
    requestAnimationFrame( () => { return this.detect(); } ); 
  }

  doKeyPress( evt ) {
    // Look for space bar
    if( evt.keyCode === 32 ) {
      // Toggle color mode
      if( this.color === null ) {
        // No color defined
        // Highlight will be at center
        // Get index for cenver of canvas
        this.color = {
          index: Math.round( ( this.canvas.clientWidth * this.canvas.clientHeight ) / 2 ) * 4
        };
      } else {
        // Color defined
        // Reset
        // Will place highlight back at center
        this.color = null;
      }
    }    
  }
}

// Constants
Follower.VIEW_SIZE = 20;

let app = new Follower();
</script>

</body>
</html>
