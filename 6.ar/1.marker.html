<html>
<head>

<title>AR Toolkit</title>

<style>
body {
  align-items: center;
  display: flex;
  flex-direction: row;
  justify-content: center;
  margin: 0;
  padding: 0;
}

canvas {
  left: 0;
  position: absolute;
  top: 0;
}

div {
  position: relative;
}
</style>

</head>
<body>

<!-- Canvas over video strem -->
<!-- For drawing located marker -->
<div>
  <video width="640" height="480"></video>
  <canvas width="640" height="480"></canvas>
</div>

<!-- Augmented reality library -->
<script src="../lib/artoolkit.min.js"></script>

<script>
class Augmented {
  constructor() {
    // Augmented reality properties
    // Controller and camera
    // Start detecting when camera is ready
    this.ar = null;
    this.camera = new ARCameraParam();
    this.camera.onload = () => {
      this.detect();
    };

    // Canvas for drawing located marker
    // Video stream
    this.canvas = document.querySelector( 'canvas' );
    this.context = this.canvas.getContext( '2d' );
    this.video = document.querySelector( 'video' );

    // Start video stream
    navigator.mediaDevices.getUserMedia( {audio: false, video: true} )
    .then( ( stream ) => {
      this.video.srcObject = stream;
      this.video.play();

      // Load camera setup
      this.camera.src = Augmented.CAMERA;
    } )
    .catch( ( error ) => {
      console.log( error );
    } );        
  }

  detect() {
    // Ensure video is rendering
    // ARToolkit will fail if nothing rendering first
    if( this.video.videoWidth ) {
      
      // Initialize controller
      // Pattern detection mode
      // Event when markers are found
      if( !this.ar ) {
        this.ar = new ARController( this.video, this.camera );
        this.ar.setPatternDetectionMode( artoolkit.AR_TEMPLATE_MATCHING_COLOR_AND_MATRIX );        
        this.ar.addEventListener( 'getMarker', ( evt ) => this.doMarker( evt ) );
      }
    }

    // If the controller is ready
    // Process the video stream
    if( this.ar ) {
      this.ar.process();
    }

    // Keep detecting
    requestAnimationFrame( () => { return this.detect(); } );         
  }

  // Found a marker
  doMarker( evt ) {
    // Clear previous drawing
    this.context.clearRect( 0, 0, this.canvas.clientWidth, this.canvas.clientHeight );

    // Draw currently detected marker
    this.context.beginPath();
    this.context.strokeStyle = 'red';
    this.context.lineWidth = 3;
    this.context.moveTo( evt.data.marker.vertex[0][0], evt.data.marker.vertex[0][1] );
    this.context.lineTo( evt.data.marker.vertex[1][0], evt.data.marker.vertex[1][1] );    
    this.context.lineTo( evt.data.marker.vertex[2][0], evt.data.marker.vertex[2][1] );        
    this.context.lineTo( evt.data.marker.vertex[3][0], evt.data.marker.vertex[3][1] );        
    this.context.lineTo( evt.data.marker.vertex[0][0], evt.data.marker.vertex[0][1] );        
    this.context.stroke();

    // Debug
    console.log( evt ); 
  }
}

// Constants
// Camera configuration
Augmented.CAMERA = '../lib/camera_para.dat';

let app = new Augmented();
</script>

</body>
</html>